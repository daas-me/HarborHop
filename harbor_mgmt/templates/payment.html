{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - HarborHop</title>
    <link href="https://fonts.googleapis.com/css2?family=Alan+Sans:wght@300..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
    <link rel="stylesheet" href="{% static 'css/payment.css' %}?v=5"
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'images/favicon_io/apple-touch-icon.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'images/favicon_io/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'images/favicon_io/favicon-16x16.png' %}">
    <link rel="manifest" href="{% static 'images/favicon_io/site.webmanifest' %}">
    <script src="https://kit.fontawesome.com/1256e3cde2.js" crossorigin="anonymous"></script>
</head>
<body>
     <header>
    <div class="logo-container">
        <a href="{% url 'home' %}" class="logo">HARBOR<span>hop</span></a>
        <p class="tagline">Hop aboard. Sail beyond</p>
    </div>
    <nav>
        <a href="{% url 'home' %}">Home</a>
        {% if user.is_authenticated %}
            <!-- Admin Dashboard Button - Only visible to admin users -->
            {% if user.profile.is_admin_user %}
                <a href="{% url 'admin_dashboard' %}" class="admin-dashboard-link">
                    <i class="fa-solid fa-chart-line dashboard-icon"></i> Admin Access
                </a>
            {% endif %}
           <a href="{% url 'reservations' %}">Manage Booking</a>
                <a href="{% url 'latest_offer' %}">Latest Offers</a>
                <a href="{% url 'contact_us' %}">Contact Us</a>
                <div class="nav-divider"></div>
                <a href="#" class="language-link">PH</a>
                <span class="language-separator">|</span>
                <a href="#" class="language-link">EN</a>
                <a href="{% url 'profile_settings' %}" class="user-name-btn">{{ user.username }}</a>
                <a href="{% url 'logout' %}" class="login-btn">Log out</a>
            {% else %}
                <a href="{% url 'latest_offer' %}">Latest Offers</a>
                <a href="{% url 'contact_us' %}" class="contact-btn">Contact Us</a>
                <div class="nav-divider"></div>
                <a href="#" class="language-link">PH</a>
                <span class="language-separator">|</span>
                <a href="#" class="language-link">EN</a>
                <a href="{% url 'login' %}" class="login-btn">Log In</a>
            {% endif %}
    </nav>
</header>

    <div class="payment-wrapper">
        <div class="page-title">
            <h1><i class="fa-solid fa-credit-card"></i> Complete Your Payment</h1>
            <p>You're almost there! Review your booking and complete payment.</p>
        </div>

        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="steps step-3">
                <div class="step completed">
                    <div class="step-number">1</div>
                    <div class="step-label">Schedules</div>
                </div>
                <div class="step completed">
                    <div class="step-number">2</div>
                    <div class="step-label">Passenger Info</div>
                </div>
                <div class="step active">
                    <div class="step-number">3</div>
                    <div class="step-label">Payment</div>
                </div>
                <div class="step">
                    <div class="step-number">4</div>
                    <div class="step-label">Complete</div>
                </div>
            </div>
        </div>

        <div class="payment-container">
            <!-- Left Side - Booking Summary -->
            <div class="booking-summary-card">
                <div class="summary-header">
                    <i class="fa-solid fa-ticket"></i>
                    <div>
                        <h2>Booking Summary</h2>
                        <p>Reference: <strong>{{ booking.booking_reference }}</strong></p>
                    </div>
                </div>

                <!-- Trip Route -->
                <div class="trip-route">
                    <div class="route-item">
                        <i class="fa-solid fa-location-dot"></i>
                        <span>{{ booking.origin }}</span>
                    </div>
                    <div class="route-arrow">
                        <i class="fa-solid fa-arrow-right"></i>
                        {% if route_distance %}
                            <span class="distance">{{ route_distance }} km</span>
                        {% endif %}
                    </div>
                    <div class="route-item">
                        <i class="fa-solid fa-location-dot"></i>
                        <span>{{ booking.destination }}</span>
                    </div>
                </div>

                <!-- Outbound Trip Details -->
                {% if booking.details.outbound %}
                <div class="journey-card outbound">
                    <div class="journey-header">
                        <i class="fa-solid fa-ship"></i>
                        <span>Departure Journey</span>
                    </div>
                    <div class="journey-details">
                        <div class="detail-row">
                            <div class="detail-item">
                                <i class="fa-solid fa-ship"></i>
                                <div>
                                    <span class="label">Company</span>
                                    <span class="value">{{ booking.details.outbound.company }}</span>
                                </div>
                            </div>
                            <div class="detail-item">
                                <i class="fa-solid fa-ferry"></i>
                                <div>
                                    <span class="label">Vessel</span>
                                    <span class="value">{{ booking.details.outbound.vessel }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-item">
                                <i class="fa-solid fa-calendar-day"></i>
                                <div>
                                    <span class="label">Date</span>
                                    <span class="value">{{ booking.details.outbound.departureDate }}</span>
                                </div>
                            </div>
                            <div class="detail-item">
                                <i class="fa-solid fa-clock"></i>
                                <div>
                                    <span class="label">Time</span>
                                    <span class="value">{{ booking.details.outbound.departureTime }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-item">
                                <i class="fa-solid fa-couch"></i>
                                <div>
                                    <span class="label">Accommodation</span>
                                    <span class="value">{{ booking.details.outbound.accommodationName }}</span>
                                </div>
                            </div>
                            <div class="detail-item">
                                <i class="fa-solid fa-chair"></i>
                                <div>
                                    <span class="label">Seat Type</span>
                                    <span class="value">{{ booking.details.outbound.seatType }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="price-row">
                            <span>Price</span>
                            <span class="price">₱{{ booking.details.outbound.price|floatformat:2 }}</span>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Return Trip Details -->
                {% if booking.details.return %}
                <div class="journey-card return">
                    <div class="journey-header">
                        <i class="fa-solid fa-ship"></i>
                        <span>Return Journey</span>
                    </div>
                    <div class="journey-details">
                        <div class="detail-row">
                            <div class="detail-item">
                                <i class="fa-solid fa-ship"></i>
                                <div>
                                    <span class="label">Company</span>
                                    <span class="value">{{ booking.details.return.company }}</span>
                                </div>
                            </div>
                            <div class="detail-item">
                                <i class="fa-solid fa-ferry"></i>
                                <div>
                                    <span class="label">Vessel</span>
                                    <span class="value">{{ booking.details.return.vessel }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-item">
                                <i class="fa-solid fa-calendar-day"></i>
                                <div>
                                    <span class="label">Date</span>
                                    <span class="value">{{ booking.details.return.departureDate }}</span>
                                </div>
                            </div>
                            <div class="detail-item">
                                <i class="fa-solid fa-clock"></i>
                                <div>
                                    <span class="label">Time</span>
                                    <span class="value">{{ booking.details.return.departureTime }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-item">
                                <i class="fa-solid fa-couch"></i>
                                <div>
                                    <span class="label">Accommodation</span>
                                    <span class="value">{{ booking.details.return.accommodationName }}</span>
                                </div>
                            </div>
                            <div class="detail-item">
                                <i class="fa-solid fa-chair"></i>
                                <div>
                                    <span class="label">Seat Type</span>
                                    <span class="value">{{ booking.details.return.seatType }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="price-row">
                            <span>Price</span>
                            <span class="price">₱{{ booking.details.return.price|floatformat:2 }}</span>
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="passengers-info">
                    <i class="fa-solid fa-users"></i>
                    <div>
                        <span class="label">Passengers</span>
                        <span class="value">
                            {{ booking.adults }} Adult(s)
                            {% if booking.children > 0 %} • {{ booking.children }} Child(ren){% endif %}
                            {% if booking.details.infants %} • {{ booking.details.infants }} Infant(s){% endif %}
                        </span>
                    </div>
                </div>

            <!-- Price Breakdown Section -->
                <div class="price-breakdown-section">
                    <div class="breakdown-header">
                        <i class="fa-solid fa-receipt"></i>
                        <h3>Price Breakdown</h3>
                    </div>
                    
                    <!-- Outbound Journey Breakdown -->
                    {% if booking.details.outbound %}
                    <div class="breakdown-journey">
                        <div class="journey-label">
                            <i class="fa-solid fa-ship"></i>
                            <span>Departure Journey</span>
                        </div>
                        
                        <div class="breakdown-items">
                            <!-- Adults -->
                            {% if booking.adults > 0 %}
                            <div class="breakdown-item">
                                <div class="item-desc">
                                    <i class="fa-solid fa-user"></i>
                                    <span>Adult × {{ booking.adults }}</span>
                                </div>
                                <span class="item-price">₱{{ booking.details.outbound.adult_price|floatformat:2 }} each</span>
                            </div>
                            <div class="breakdown-subtotal-item">
                                <span>Adults Subtotal</span>
                                <span>₱{{ booking.details.outbound.adult_price|floatformat:2|multiply:booking.adults }}</span>
                            </div>
                            {% endif %}
                            
                            <!-- Children (50% discount) -->
                            {% if booking.details.outbound.valid_children > 0 %}
                            <div class="breakdown-item child">
                                <div class="item-desc">
                                    <i class="fa-solid fa-child"></i>
                                    <span>Child × {{ booking.details.outbound.valid_children }} <span class="discount-badge">50% OFF</span></span>
                                    <span class="age-verified-badge"><i class="fa-solid fa-check-circle"></i> Age Verified</span>
                                </div>
                                <span class="item-price child-price">₱{{ booking.details.outbound.child_price|floatformat:2 }} each</span>
                            </div>
                            {% endif %}
                            
                            <!-- Infants (if any) -->
                            {% if booking.details.infants > 0 %}
                            <div class="breakdown-item infant">
                                <div class="item-desc">
                                    <i class="fa-solid fa-baby"></i>
                                    <span>Infant × {{ booking.details.infants }}</span>
                                </div>
                                <span class="item-price infant-price">FREE</span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="breakdown-subtotal">
                            <span>Departure Subtotal</span>
                            <span class="subtotal-amount">₱{{ booking.details.outbound.price|floatformat:2 }}</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Return Journey Breakdown (if round trip) -->
                    {% if booking.details.return %}
                    <div class="breakdown-journey">
                        <div class="journey-label return">
                            <i class="fa-solid fa-ship"></i>
                            <span>Return Journey</span>
                        </div>
                        
                        <div class="breakdown-items">
                            <!-- Adults -->
                            {% if booking.adults > 0 %}
                            <div class="breakdown-item">
                                <div class="item-desc">
                                    <i class="fa-solid fa-user"></i>
                                    <span>Adult × {{ booking.adults }}</span>
                                </div>
                                <span class="item-price">₱{{ booking.details.return.adult_price|floatformat:2 }} each</span>
                            </div>
                            <div class="breakdown-subtotal-item">
                                <span>Adults Subtotal</span>
                                <span>₱{{ booking.details.return.adult_price|floatformat:2|multiply:booking.adults }}</span>
                            </div>
                            {% endif %}
                            
                            <!-- Children (50% discount) -->
                            {% if booking.children > 0 %}
                            <div class="breakdown-item child">
                                <div class="item-desc">
                                    <i class="fa-solid fa-child"></i>
                                    <span>Child × {{ booking.children }} <span class="discount-badge">50% OFF</span></span>
                                </div>
                                <span class="item-price child-price">₱{{ booking.details.return.child_price|floatformat:2 }} each</span>
                            </div>
                            <div class="breakdown-subtotal-item">
                                <span>Children Subtotal</span>
                                <span>₱{{ booking.details.return.child_price|floatformat:2|multiply:booking.children }}</span>
                            </div>
                            {% endif %}
                            
                            <!-- Infants (if any) -->
                            {% if booking.details.infants > 0 %}
                            <div class="breakdown-item infant">
                                <div class="item-desc">
                                    <i class="fa-solid fa-baby"></i>
                                    <span>Infant × {{ booking.details.infants }}</span>
                                </div>
                                <span class="item-price infant-price">FREE</span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="breakdown-subtotal">
                            <span>Return Subtotal</span>
                            <span class="subtotal-amount">₱{{ booking.details.return.price|floatformat:2 }}</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Grand Total -->
                    <div class="breakdown-total">
                        <div class="total-row">
                            <span class="total-label">
                                <i class="fa-solid fa-calculator"></i>
                                Grand Total
                            </span>
                            <span class="total-amount">₱{{ booking.total_price|floatformat:2 }}</span>
                        </div>
                        <p class="total-note">All taxes and fees included • Children save 50%</p>
                    </div>
                </div>
            </div>

            <!-- Right Side - Payment Form -->
            <div class="payment-form-card">
                <div class="payment-header">
                    <h3><i class="fa-solid fa-wallet"></i> Payment Details</h3>
                </div>

                <div class="total-amount-display">
                    <span class="amount-label">Total Amount</span>
                    <span class="amount-value">₱{{ booking.total_price|floatformat:2 }}</span>
                </div>

                <form method="post" class="payment-form">
                    {% csrf_token %}
                    
                   <div class="form-group">
                        <label><i class="fa-solid fa-credit-card"></i> Payment Method</label>
                        <div class="payment-methods">
                            <!-- E-Wallet Option with Dropdown -->
                            <label class="payment-method-option">
                                <input type="radio" name="payment_method" value="ewallet" checked>
                                <div class="method-card">
                                    <i class="fa-solid fa-wallet"></i>
                                    <span>E-Wallet</span>
                                </div>
                            </label>
                            
                            <!-- E-Wallet Dropdown (shown when E-Wallet is selected) -->
                            <div class="ewallet-dropdown" id="ewallet-dropdown">
                                <label for="ewallet-select">Select E-Wallet Provider:</label>
                                <select name="ewallet_provider" id="ewallet-select" class="ewallet-select">
                                    <option value="gcash">GCash</option>
                                    <option value="maya">Maya</option>
                                    <option value="shopeepay">ShopeePay</option>
                                    <option value="gotyme">GoTyme</option>
                                </select>
                            </div>

                            <!-- Credit Card Option -->
                            <label class="payment-method-option">
                                <input type="radio" name="payment_method" value="credit_card">
                                <div class="method-card">
                                    <i class="fa-solid fa-credit-card"></i>
                                    <span>Credit Card</span>
                                </div>
                            </label>

                            <!-- PayPal Option -->
                            <label class="payment-method-option">
                                <input type="radio" name="payment_method" value="paypal">
                                <div class="method-card">
                                    <i class="fa-brands fa-paypal"></i>
                                    <span>PayPal</span>
                                </div>
                            </label>
                        </div>
                        <p style="margin-top: 10px; font-size: 0.9rem; color: #555;">
                            Selecting <strong>Credit Card</strong> will securely redirect you to the Stripe test checkout page to complete your payment.
                        </p>
                    </div>

                    <div class="payment-info-box">
                        <i class="fa-solid fa-shield-halved"></i>
                        <div>
                            <strong>Secure Payment</strong>
                            <p>Your payment information is encrypted and secure.</p>
                        </div>
                    </div>

                    <!-- Ticket Rules Summary -->
                    <div class="ticket-rules-box">
                        <div class="rules-header">
                            <i class="fa-solid fa-clipboard-list"></i>
                            <strong>Important Ticket Rules</strong>
                        </div>
                        <ul class="rules-list">
                            <li><strong>Check-in:</strong> Arrive at least 2 hours before departure</li>
                            <li><strong>Valid ID Required:</strong> Present valid ID for boarding</li>
                            <li><strong>Ticket Validity:</strong> Valid only for the voyage indicated</li>
                            <li><strong>Refund/Reschedule:</strong> Within 60 days from departure, subject to surcharge</li>
                            <li><strong>Baggage:</strong> 2 bags (0.05 cubic meter or 100kg) for 2nd class/tourist</li>
                        </ul>
                        <a href="#" class="view-full-rules" onclick="openRulesModal(event)">
                            <i class="fa-solid fa-file-lines"></i> View Full Ticket Rules & Conditions
                        </a>
                    </div>

                    <div class="form-actions">
                        <a href="javascript:history.back()" class="btn-back">
                            <i class="fa-solid fa-arrow-left"></i> Back
                        </a>
                        <button type="submit" class="btn-pay">
                            <i class="fa-solid fa-lock"></i> Complete Payment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <div class="footer-logo">
                    <div class="logo-text">HARBOR<span class="highlight">hop</span></div>
                    <p class="tagline">Hop Aboard. Sail Beyond</p>
                </div>
                <p style="color: #2c3e50; margin-top: 20px;">Experience the best cruise booking platform with exclusive deals and premium customer service.</p>
            </div>

            <div class="footer-section">
                <h4>Quick Links</h4>
                <ul class="footer-links">
                    <li><a href="{% url 'home' %}">Home</a></li>
                </ul>
            </div>

            <div class="footer-section">
                <h4>Contact Us</h4>
                <div class="contact-info">
                   <p><i class="fa-solid fa-envelope"></i>support@harborhop.com</p>
                    <p><i class="fa-solid fa-phone"></i> +63 995 570 2354</p>
                    <p><i class="fa-solid fa-location-dot"></i> Natalio B. Bacalso Ave, Cebu City, Philippines 6000</p>
                </div>
            </div>

            <div class="footer-section">
                <h4>Connect With Us</h4>
                <div class="social-media">
                    <a href="#" title="Facebook">
                        <img src="https://cdn-icons-png.flaticon.com/512/124/124010.png" alt="Facebook">
                    </a>
                    <a href="#" title="Twitter">
                        <img src="https://cdn-icons-png.flaticon.com/512/3256/3256013.png" alt="Twitter">
                    </a>
                    <a href="#" title="Instagram">
                        <img src="https://cdn-icons-png.flaticon.com/512/174/174855.png" alt="Instagram">
                    </a>
                </div>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>&copy; 2025 HarborHop. All rights reserved. | <a href="#">Privacy Policy</a> | <a href="#">Terms of Service</a></p>
        </div>
    </footer>

    <!-- Ticket Rules Modal -->
    <div id="rulesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fa-solid fa-clipboard-list"></i> Ticket Rules & Conditions</h2>
                <button class="modal-close" onclick="closeRulesModal()">&times;</button>
            </div>
            <div class="modal-body">
                <ol class="full-rules-list">
                    <li>Ticket is non-transferable and shall be used solely by Passenger named herein. Passenger is required to present a valid ID upon check-in or may be refused boarding if can not present.</li>
                    
                    <li>Ticket is valid only for the voyage indicated herein and shall be deemed automatically canceled if not used. In cases wherein the Passenger was unable to use the ticket, the ticket may still be refunded or rescheduled within sixty (60) days from date of departure, subject to surcharge.</li>
                    
                    <li>Passenger must be at the Passenger Terminal for check-in at least two (2) hours before departure time. Carrier reserves the right to cancel the ticket of any Passenger who fails to check-in thirty (30) minutes before scheduled departure and may issue the same accommodation to another person.</li>
                    
                    <li>Passenger undertakes to faithfully comply with the rules and regulations of the Carrier involving the maintenance of peace and order, safety, and sanitation on board the vessel.</li>
                    
                    <li>Passenger voluntarily agrees that Carrier shall not be liable for death, injury, or delay to the Passenger and/or loss, damage, or delay to any baggage due to any fortuitous event, war, rebellion, strike, acts of terrorism, navigational requirements, government intervention, and other causes beyond the control of the Carrier. It is agreed that the term "baggage" shall mean only such thing that is necessary for the personal use of the Passenger during the voyage, excluding all money, jewelry, merchandise, securities, and other articles of similar nature, for which the Carrier shall not be liable for unless transported under a Bill of Lading. The liability of the Carrier in case of loss, damage, or delay to the Passenger's baggage shall be limited to Five Hundred Pesos (₱500.00) for First Class passengers and a reduced proportion thereof in the case of all other passengers. Carrier shall have no liability whatsoever in connection with this voyage unless a written notice of claim is presented to the Carrier within fifteen (15) days or unless a suit is instituted within thirty (30) days from the day the Passenger disembarks or from the day the vessel arrives at the Passenger's port of destination, whichever is earlier.</li>
                    
                    <li>Passengers can bring two (2) 0.05 cubic meter in size or 100 kilos of baggage on board, on 2nd class and tourist accommodations. Private room and cabin passengers have double allowance in terms of quantity but not in size. Minor's allowance is half in size that of an adult. Baggage in excess of allowance will be deemed as cargo and will be treated as such and charged accordingly.</li>
                    
                    <li>Carrier reserves the right to refuse boarding to Passenger/s who pose a threat to the security, order, comfort, safety & health of other passengers and the vessel and Passenger/s whose payment is made through fraudulent means.</li>
                    
                    <li>Sick Passengers must present a medical certificate dated five (5) days within departure date, attesting to their fitness to undertake sea travel. Non-ambulatory cases, especially those with life support, should be accompanied by a licensed nurse/doctor companion with enough supply of medication for the duration of the trip. Carrier reserved the right to deny boarding of a sick passenger.</li>
                    
                    <li>Pregnant Passengers within 1 to 6 months (up to 28 weeks) are required to present a medical certificate issued at least the day prior the departure date attesting to their fitness to travel by boat indicated with the specific date of departure. 7 months and beyond (29 weeks and beyond) are no longer accepted for sea travel.</li>
                    
                    <li>Passengers below three (3) years old are considered infants. Passengers who are between three (3) to eleven (11) years of age but below one meter in height are considered minors.</li>
                    
                    <li>Carrier is not responsible to replace lost Passage Sales Invoice. Passage Official Receipt mutilated beyond recognition shall not be accepted for check-in. Passenger will have to purchase a new ticket.</li>
                    
                    <li>Ticket may be rescheduled or refunded subject to applicable surcharge at the issuing ticket outlet or at Trans-Asia Cebu-Main offices, provided that the Passenger named therein presents his complete set of ticket and a photocopy of valid ID (with picture) as proof of identity, and that the ticket has not yet expired or lapsed sixty (60) days from departure date. Ticket rescheduling can only be done once and is subject to fare rates prevailing at the time of rescheduling.</li>
                    
                    <li>In case the vessel cannot continue or complete the voyage for any cause whatsoever, Carrier reserves the right to cancel the trip and refund the Passenger the unused cost of said ticket or reschedule for another date/destination.</li>
                    
                    <li>Sailing schedule of the vessel is not guaranteed and may change between the date of purchase and the date of travel. Carrier will exert reasonable efforts to notify affected Passengers of any change of the sailing schedule, but will not be liable in any way for any loss or damage that may be incurred as a result of such change.</li>
                    
                    <li>Carrier may cancel, terminate, or delay any departing vessel or suspend the operation at any time after a reservation has been made.</li>
                    
                    <li>Carrier is not responsible for any connecting trip of the Passenger or for any misconnection arising from any delay or cancellation of the scheduled trip.</li>
                    
                    <li>Carrier reserves the right to deploy another vessel without prior notice. Affected accommodations will be automatically downgraded should there be no available accommodations, and the fare difference will be refunded to the Passenger. In the event all accommodations are fully booked, Passenger agrees to be refunded in full.</li>
                    
                    <li>Any unauthorized alteration of this ticket shall render the same null and void.</li>
                </ol>
            </div>
            <div class="modal-footer">
                <button class="btn-close-modal" onclick="closeRulesModal()">Close</button>
            </div>
        </div>
    </div>

<!-- E-Wallet Payment Gateway Modal -->
<div id="paymentGatewayModal" class="modal payment-gateway-modal">
    <div class="modal-content">
        <div class="modal-header payment-gateway-header">
            <div class="gateway-logo">
                <i class="fa-solid fa-wallet"></i>
                <div>
                    <h2>E-Wallet Payment</h2>
                    <p class="gateway-subtitle">Complete your payment securely</p>
                </div>
            </div>
            <button class="modal-close" onclick="closePaymentGateway()">&times;</button>
        </div>
        <div class="modal-body payment-gateway-body">
            <div class="payment-provider-info">
                <div class="provider-badge">
                    <i class="fa-solid fa-wallet"></i>
                    <span id="selected-provider">GCash</span>
                </div>
                <div class="amount-display-gateway">
                    <span class="amount-label-small">Amount to Pay</span>
                    <span class="amount-value-large">₱{{ booking.total_price|floatformat:2 }}</span>
                </div>
            </div>

            <form id="gatewayPaymentForm">
                <div class="gateway-form-group">
                    <label>
                        <i class="fa-solid fa-user"></i>
                        Full Name
                    </label>
                    <input 
                        type="text" 
                        id="ewallet-name" 
                        class="gateway-input" 
                        placeholder="Juan Dela Cruz" 
                        required
                    >
                    <span class="input-hint">Enter your full name as registered</span>
                </div>

                <div class="gateway-form-group">
                    <label>
                        <i class="fa-solid fa-mobile-screen"></i>
                        Phone / Account Number
                    </label>
                    <input 
                        type="tel" 
                        id="phone-number" 
                        class="gateway-input" 
                        placeholder="09171234567" 
                        pattern="[0-9]{11}"
                        maxlength="11"
                        required
                    >
                    <span class="input-hint">Enter your 11-digit phone or account number</span>
                </div>

                <div class="gateway-form-group">
                    <label>
                        <i class="fa-solid fa-peso-sign"></i>
                        Confirm Amount
                    </label>
                    <input 
                        type="text" 
                        id="confirm-amount" 
                        class="gateway-input" 
                        value="{{ booking.total_price|floatformat:2 }}"
                        readonly
                    >
                </div>

                <div class="security-notice">
                    <i class="fa-solid fa-shield-halved"></i>
                    <div>
                        <strong>Secure Transaction</strong>
                        <p>You will receive a confirmation on your mobile device. Please approve the transaction to complete payment.</p>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer payment-gateway-footer">
            <button type="button" class="btn-gateway-cancel" onclick="closePaymentGateway()">
                <i class="fa-solid fa-xmark"></i> Cancel
            </button>
            <button type="button" class="btn-gateway-pay" onclick="processPayment()">
                <i class="fa-solid fa-check"></i> Confirm Payment
            </button>
        </div>
    </div>
</div>

<!-- PayPal Payment Modal -->
<div id="paypalModal" class="modal payment-gateway-modal">
    <div class="modal-content">
        <div class="modal-header paypal-header">
            <div class="gateway-logo">
                <i class="fa-brands fa-paypal"></i>
                <div>
                    <h2>PayPal Payment</h2>
                    <p class="gateway-subtitle">Pay securely with PayPal</p>
                </div>
            </div>
            <button class="modal-close" onclick="closePaypalModal()">&times;</button>
        </div>
        <div class="modal-body payment-gateway-body">
            <div class="payment-provider-info paypal-info">
                <div class="provider-badge paypal-badge">
                    <i class="fa-brands fa-paypal"></i>
                    <span>PayPal</span>
                </div>
                <div class="amount-display-gateway">
                    <span class="amount-label-small">Amount to Pay</span>
                    <span class="amount-value-large">₱{{ booking.total_price|floatformat:2 }}</span>
                </div>
            </div>

            <div class="paypal-info-box">
                <i class="fa-solid fa-info-circle"></i>
                <div>
                    <strong>PayPal Information</strong>
                    <p>You will be redirected to PayPal to complete your payment securely.</p>
                </div>
            </div>

            <form id="paypalForm">
                <div class="gateway-form-group">
                    <label>
                        <i class="fa-solid fa-envelope"></i>
                        PayPal Email
                    </label>
                    <input 
                        type="email" 
                        id="paypal-email" 
                        class="gateway-input" 
                        placeholder="your.email@example.com" 
                        required
                    >
                    <span class="input-hint">Enter your PayPal account email</span>
                </div>

                <div class="security-notice paypal-security">
                    <i class="fa-solid fa-lock"></i>
                    <div>
                        <strong>Secure with PayPal</strong>
                        <p>Your payment is protected by PayPal's Buyer Protection policy.</p>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer payment-gateway-footer">
            <button type="button" class="btn-gateway-cancel" onclick="closePaypalModal()">
                <i class="fa-solid fa-xmark"></i> Cancel
            </button>
            <button type="button" class="btn-gateway-pay paypal-btn" onclick="processPaypalPayment()">
                <i class="fa-brands fa-paypal"></i> Pay with PayPal
            </button>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="paymentLoadingOverlay" class="payment-loading-overlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <h3>Processing Payment</h3>
        <p>Please wait while we process your payment...</p>
    </div>
</div>

<script>
    // Rules Modal Functions
    function openRulesModal(event) {
        event.preventDefault();
        document.getElementById('rulesModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closeRulesModal() {
        document.getElementById('rulesModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // Payment Gateway Functions
    function openPaymentGateway() {
        const selectedMethod = document.querySelector('input[name="payment_method"]:checked').value;
        
        if (selectedMethod === 'ewallet') {
            const ewalletSelect = document.getElementById('ewallet-select');
            const providerName = ewalletSelect.options[ewalletSelect.selectedIndex].text;
            document.getElementById('selected-provider').textContent = providerName;
            document.getElementById('paymentGatewayModal').style.display = 'block';
            document.getElementById('gatewayPaymentForm').reset();
            document.getElementById('confirm-amount').value = '{{ booking.total_price }}';
            document.body.style.overflow = 'hidden';
        } else if (selectedMethod === 'paypal') {
            document.getElementById('paypalModal').style.display = 'block';
            document.getElementById('paypalForm').reset();
            document.body.style.overflow = 'hidden';
        }
        // Note: credit_card is handled by Stripe redirect in form submit
    }

    function closePaymentGateway() {
        document.getElementById('paymentGatewayModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function closePaypalModal() {
        document.getElementById('paypalModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function processPayment() {
        const form = document.getElementById('gatewayPaymentForm');
        
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        const phoneNumber = document.getElementById('phone-number').value;
        
        if (phoneNumber.length !== 11) {
            alert('Please enter a valid 11-digit phone number');
            return;
        }
        
        closePaymentGateway();
        showLoadingAndSubmit();
    }

    function processPaypalPayment() {
        const form = document.getElementById('paypalForm');
        
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        closePaypalModal();
        showLoadingAndSubmit();
    }

    function showLoadingAndSubmit() {
        const loadingOverlay = document.getElementById('paymentLoadingOverlay');
        loadingOverlay.classList.add('show');
        
        setTimeout(function() {
            loadingOverlay.classList.remove('show');
            document.querySelector('.payment-form').submit();
        }, 2000);
    }

    // Document Ready
    document.addEventListener('DOMContentLoaded', function() {
        // E-Wallet Dropdown Toggle
        const paymentMethodRadios = document.querySelectorAll('input[name="payment_method"]');
        const ewalletDropdown = document.getElementById('ewallet-dropdown');
        
        function toggleEwalletDropdown() {
            const selectedMethod = document.querySelector('input[name="payment_method"]:checked').value;
            
            if (selectedMethod === 'ewallet') {
                ewalletDropdown.classList.add('show');
            } else {
                ewalletDropdown.classList.remove('show');
            }
        }
    </script>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        (function() {
            const form = document.querySelector('.payment-form');
            if (!form) return;

            const stripePublicKey = '{{ stripe_public_key|escapejs }}';

            form.addEventListener('submit', function (e) {
                const selected = form.querySelector('input[name="payment_method"]:checked');
                const method = selected ? selected.value : '';

                if (method !== 'credit_card') {
                    return; // let normal POST flow handle other methods
                }

                e.preventDefault();

                if (!stripePublicKey) {
                    alert('Stripe is not configured.');
                    return;
                }

                const stripe = Stripe(stripePublicKey);
                const csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;

                fetch('{% url "stripe_checkout" booking.id %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: JSON.stringify({}),
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.sessionId) {
                        throw new Error('No sessionId returned');
                    }
                    return stripe.redirectToCheckout({ sessionId: data.sessionId });
                })
                .then(function (result) {
                    if (result && result.error) {
                        alert(result.error.message);
                    }
                })
                .catch(function (error) {
                    console.error('Error starting Stripe checkout:', error);
                    alert('Unable to start Stripe payment. Please try again later.');
                });
            });
        })();
    

document.addEventListener('DOMContentLoaded', function() {
    // E-Wallet Dropdown Toggle
    const paymentMethodRadios = document.querySelectorAll('input[name="payment_method"]');
    const ewalletDropdown = document.getElementById('ewallet-dropdown');
    
    function toggleEwalletDropdown() {
        const selectedMethod = document.querySelector('input[name="payment_method"]:checked');
        if (selectedMethod && selectedMethod.value === 'ewallet') {
            ewalletDropdown.classList.add('show');
        } else {
            ewalletDropdown.classList.remove('show');
        }
    }
    
    // Initial check
    toggleEwalletDropdown();
    
    // Add change listeners
    paymentMethodRadios.forEach(radio => {
        radio.addEventListener('change', toggleEwalletDropdown);
    });
    
    // INTERCEPT FORM SUBMISSION
    const form = document.querySelector('.payment-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const selected = form.querySelector('input[name="payment_method"]:checked');
            const method = selected ? selected.value : '';
            
            // Only allow credit_card to submit normally (Stripe handles it)
            if (method === 'credit_card') {
                return; // Let the Stripe handler take over
            }
            
            // Prevent default submission for e-wallet and PayPal
            e.preventDefault();
            
            // Open appropriate modal
            if (method === 'ewallet') {
                openPaymentGateway();
            } else if (method === 'paypal') {
                const paypalModal = document.getElementById('paypalModal');
                paypalModal.style.display = 'block';
                document.getElementById('paypalForm').reset();
                document.body.style.overflow = 'hidden';
            }
        });
    }
});

// Keep all existing modal functions exactly as they are
function openRulesModal(event) {
    event.preventDefault();
    document.getElementById('rulesModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeRulesModal() {
    document.getElementById('rulesModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function openPaymentGateway() {
    const selectedMethod = document.querySelector('input[name="payment_method"]:checked').value;
    
    if (selectedMethod === 'ewallet') {
        const ewalletSelect = document.getElementById('ewallet-select');
        const providerName = ewalletSelect.options[ewalletSelect.selectedIndex].text;
        document.getElementById('selected-provider').textContent = providerName;
        document.getElementById('paymentGatewayModal').style.display = 'block';
        document.getElementById('gatewayPaymentForm').reset();
        document.getElementById('confirm-amount').value = '{{ booking.total_price|floatformat:2 }}';
        document.body.style.overflow = 'hidden';
    }
}

function closePaymentGateway() {
    document.getElementById('paymentGatewayModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function closePaypalModal() {
    document.getElementById('paypalModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function processPayment() {
    const form = document.getElementById('gatewayPaymentForm');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const fullName = document.getElementById('ewallet-name').value;
    const phoneNumber = document.getElementById('phone-number').value;
    
    if (!fullName || fullName.trim().length < 3) {
        alert('Please enter your full name');
        return;
    }
    
    if (phoneNumber.length !== 11) {
        alert('Please enter a valid 11-digit phone or account number');
        return;
    }
    
    closePaymentGateway();
    showLoadingAndSubmit();
}

function processPaypalPayment() {
    const form = document.getElementById('paypalForm');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    closePaypalModal();
    showLoadingAndSubmit();
}

function showLoadingAndSubmit() {
    const loadingOverlay = document.getElementById('paymentLoadingOverlay');
    loadingOverlay.classList.add('show');
    
    setTimeout(function() {
        loadingOverlay.classList.remove('show');
        // Submit the actual form
        document.querySelector('.payment-form').submit();
    }, 2000);
}
    </script>
</body>
</html>